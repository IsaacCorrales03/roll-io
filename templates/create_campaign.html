<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Crear Campa√±a - Chronicle20</title>
<style>
    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #eee;
        min-height: 100vh;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px 20px;
    }

    h1 {
        margin: 0 0 30px 0;
        font-size: 32px;
        font-weight: 300;
        letter-spacing: 1px;
        text-align: center;
        color: #fff;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .grid {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 24px;
        align-items: start;
    }

    .panel {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        padding: 24px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .panel h2 {
        margin: 0 0 20px 0;
        font-size: 18px;
        font-weight: 600;
        color: #a78bfa;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .form-group {
        margin-bottom: 18px;
    }

    label {
        display: block;
        margin-bottom: 6px;
        font-size: 13px;
        font-weight: 500;
        color: #cbd5e1;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    input[type="text"],
    input[type="number"],
    textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.3);
        color: white;
        font-size: 14px;
        transition: all 0.2s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus {
        outline: none;
        border-color: #a78bfa;
        background: rgba(0, 0, 0, 0.4);
        box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
    }

    textarea {
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
    }

    input[type="file"] {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1px dashed rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.2);
        color: #cbd5e1;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
    }

    input[type="file"]:hover {
        border-color: #a78bfa;
        background: rgba(167, 139, 250, 0.1);
    }

    .btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        border: none;
        color: white;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        border-radius: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
    }

    .btn:active {
        transform: translateY(0);
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .canvas-panel {
        position: relative;
        min-height: 600px;
    }

    .canvas-wrapper {
        position: relative;
        width: 100%;
        height: 600px;
        border-radius: 8px;
        overflow: hidden;
        background: #000;
        cursor: grab;
    }

    .canvas-wrapper.panning {
        cursor: grabbing;
    }

    .canvas-wrapper.selecting {
        cursor: crosshair;
    }

    canvas {
        position: absolute;
        top: 0;
        left: 0;
    }

    .controls {
        position: absolute;
        top: 16px;
        right: 16px;
        display: flex;
        gap: 8px;
        z-index: 10;
    }

    .control-btn {
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 18px;
    }

    .control-btn:hover {
        background: rgba(167, 139, 250, 0.3);
        border-color: #a78bfa;
    }

    .control-btn.active {
        background: #a78bfa;
        border-color: #a78bfa;
    }

    .info-badge {
        position: absolute;
        bottom: 16px;
        left: 16px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        color: #cbd5e1;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .help-text {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 4px;
        font-style: italic;
    }

    .divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 20px 0;
    }
</style>
</head>
<body>

<div class="container">
    <h1>‚ú® Crear Nueva Campa√±a</h1>

    <div class="grid">

        <!-- PANEL IZQUIERDO -->
        <div class="panel">
            <h2>üìã Informaci√≥n</h2>

            <div class="form-group">
                <label>Nombre de la campa√±a</label>
                <input type="text" id="campaign-name" placeholder="Ej: La Mina Perdida">
            </div>

            <div class="form-group">
                <label>Nombre del mundo</label>
                <input type="text" id="world-name" placeholder="Ej: Faer√ªn">
            </div>

            <div class="form-group">
                <label>Lore del mundo</label>
                <textarea id="world-lore" placeholder="Descripci√≥n del mundo, historia, contexto..."></textarea>
            </div>

            <div class="divider"></div>

            <h2>üó∫Ô∏è Escena Inicial</h2>

            <div class="form-group">
                <label>Nombre de la escena</label>
                <input type="text" id="scene-name" placeholder="Ej: Entrada de la mina">
            </div>

            <div class="form-group">
                <label>Mapa de la escena</label>
                <input type="file" id="map-upload" accept="image/*">
                <div class="help-text">Formatos: JPG, PNG, WEBP</div>
            </div>

            <div class="form-group">
                <label>Tama√±o del tile (px)</label>
                <input type="number" id="tile-size" value="64" min="32" max="128" step="8">
                <div class="help-text">Define la cuadr√≠cula del mapa</div>
            </div>

            <div class="divider"></div>

            <button class="btn" onclick="createCampaign()">üöÄ Crear Campa√±a</button>
        </div>

        <!-- CANVAS -->
        <div class="panel canvas-panel">
            <h2>üé® Editor de Mapa</h2>
            
            <div class="canvas-wrapper" id="canvas-container">
                <canvas id="map-canvas"></canvas>

                <div class="controls">
                    <button class="control-btn" id="pan-btn" onclick="setMode('pan')" title="Pan (Mover)">‚úã</button>
                    <button class="control-btn active" id="select-btn" onclick="setMode('select')" title="Seleccionar √°rea">‚¨ö</button>
                    <button class="control-btn" onclick="toggleGrid()" title="Toggle Grid">‚äû</button>
                    <button class="control-btn" onclick="resetView()" title="Reset View">‚Üª</button>
                </div>

                <div class="info-badge" id="info">
                    <div>Arrastra para seleccionar el √°rea de juego</div>
                    <div id="selection-info"></div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
/* ================================
   VARIABLES GLOBALES
================================ */
const canvas = document.getElementById("map-canvas");
const ctx = canvas.getContext("2d");
const container = document.getElementById("canvas-container");
const fileInput = document.getElementById("map-upload");

let image = new Image();
let selectedFile = null;

// Estado del canvas
let offsetX = 0;
let offsetY = 0;
let scale = 1;

// Selecci√≥n
let selecting = false;
let selectionStart = { x: 0, y: 0 };
let selection = null;

// Pan
let panning = false;
let panStart = { x: 0, y: 0 };
let panOffset = { x: 0, y: 0 };

// Configuraci√≥n
let showGrid = true;
let mode = 'select'; // 'select' | 'pan'

/* ================================
   CARGA DE IMAGEN
================================ */
fileInput.addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;

    selectedFile = file;

    const reader = new FileReader();
    reader.onload = function(evt) {
        image.src = evt.target.result;
    };
    reader.readAsDataURL(file);
});

image.onload = function() {
    // Ajustar canvas al contenedor
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;

    // Centrar imagen
    const scaleX = canvas.width / image.width;
    const scaleY = canvas.height / image.height;
    scale = Math.min(scaleX, scaleY, 1) * 0.9;

    panOffset.x = (canvas.width - image.width * scale) / 2;
    panOffset.y = (canvas.height - image.height * scale) / 2;

    draw();
};

/* ================================
   MODOS DE INTERACCI√ìN
================================ */
function setMode(newMode) {
    mode = newMode;
    document.getElementById('pan-btn').classList.toggle('active', mode === 'pan');
    document.getElementById('select-btn').classList.toggle('active', mode === 'select');
    container.classList.toggle('selecting', mode === 'select');
}

function toggleGrid() {
    showGrid = !showGrid;
    draw();
}

function resetView() {
    if (!image.src) return;
    
    const scaleX = canvas.width / image.width;
    const scaleY = canvas.height / image.height;
    scale = Math.min(scaleX, scaleY, 1) * 0.9;

    panOffset.x = (canvas.width - image.width * scale) / 2;
    panOffset.y = (canvas.height - image.height * scale) / 2;

    selection = null;
    draw();
}

/* ================================
   MOUSE EVENTS
================================ */
canvas.addEventListener("mousedown", e => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    if (mode === 'pan') {
        panning = true;
        panStart = { x: mouseX - panOffset.x, y: mouseY - panOffset.y };
        container.classList.add('panning');
    } else if (mode === 'select') {
        selecting = true;
        // Convertir a coordenadas de imagen
        selectionStart = screenToImage(mouseX, mouseY);
    }
});

canvas.addEventListener("mousemove", e => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    if (panning) {
        panOffset.x = mouseX - panStart.x;
        panOffset.y = mouseY - panStart.y;
        draw();
    } else if (selecting) {
        const current = screenToImage(mouseX, mouseY);
        
        selection = {
            x: Math.min(selectionStart.x, current.x),
            y: Math.min(selectionStart.y, current.y),
            width: Math.abs(current.x - selectionStart.x),
            height: Math.abs(current.y - selectionStart.y)
        };

        draw();
        updateSelectionInfo();
    }
});

canvas.addEventListener("mouseup", () => {
    panning = false;
    selecting = false;
    container.classList.remove('panning');
});

canvas.addEventListener("mouseleave", () => {
    panning = false;
    selecting = false;
    container.classList.remove('panning');
});

// Zoom con rueda del mouse
canvas.addEventListener("wheel", e => {
    e.preventDefault();
    
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
    const newScale = Math.max(0.1, Math.min(5, scale * zoomFactor));

    // Zoom hacia el mouse
    const worldX = (mouseX - panOffset.x) / scale;
    const worldY = (mouseY - panOffset.y) / scale;

    panOffset.x = mouseX - worldX * newScale;
    panOffset.y = mouseY - worldY * newScale;

    scale = newScale;
    draw();
});

/* ================================
   CONVERSI√ìN DE COORDENADAS
================================ */
function screenToImage(screenX, screenY) {
    return {
        x: Math.round((screenX - panOffset.x) / scale),
        y: Math.round((screenY - panOffset.y) / scale)
    };
}

function imageToScreen(imageX, imageY) {
    return {
        x: imageX * scale + panOffset.x,
        y: imageY * scale + panOffset.y
    };
}

/* ================================
   RENDERIZADO
================================ */
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (!image.src) {
        ctx.fillStyle = '#1a1a2e';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#94a3b8';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Sube un mapa para empezar', canvas.width / 2, canvas.height / 2);
        return;
    }

    // Dibujar imagen
    ctx.save();
    ctx.translate(panOffset.x, panOffset.y);
    ctx.scale(scale, scale);
    ctx.drawImage(image, 0, 0);
    ctx.restore();

    // Dibujar grid
    if (showGrid) {
        drawGrid();
    }

    // Dibujar selecci√≥n
    if (selection) {
        const screenPos = imageToScreen(selection.x, selection.y);
        const width = selection.width * scale;
        const height = selection.height * scale;

        ctx.strokeStyle = '#a78bfa';
        ctx.lineWidth = 3;
        ctx.strokeRect(screenPos.x, screenPos.y, width, height);

        ctx.fillStyle = 'rgba(167, 139, 250, 0.1)';
        ctx.fillRect(screenPos.x, screenPos.y, width, height);

        // Esquinas
        const cornerSize = 8;
        ctx.fillStyle = '#a78bfa';
        ctx.fillRect(screenPos.x - cornerSize/2, screenPos.y - cornerSize/2, cornerSize, cornerSize);
        ctx.fillRect(screenPos.x + width - cornerSize/2, screenPos.y - cornerSize/2, cornerSize, cornerSize);
        ctx.fillRect(screenPos.x - cornerSize/2, screenPos.y + height - cornerSize/2, cornerSize, cornerSize);
        ctx.fillRect(screenPos.x + width - cornerSize/2, screenPos.y + height - cornerSize/2, cornerSize, cornerSize);
    }
}

function drawGrid() {
    const tileSize = parseInt(document.getElementById('tile-size').value) || 64;
    
    ctx.save();
    ctx.translate(panOffset.x, panOffset.y);
    ctx.scale(scale, scale);

    ctx.strokeStyle = 'rgba(167, 139, 250, 0.2)';
    ctx.lineWidth = 1 / scale;

    // L√≠neas verticales
    for (let x = 0; x < image.width; x += tileSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, image.height);
        ctx.stroke();
    }

    // L√≠neas horizontales
    for (let y = 0; y < image.height; y += tileSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(image.width, y);
        ctx.stroke();
    }

    ctx.restore();
}

function updateSelectionInfo() {
    const tileSize = parseInt(document.getElementById('tile-size').value) || 64;
    const tilesX = Math.floor(selection.width / tileSize);
    const tilesY = Math.floor(selection.height / tileSize);
    
    document.getElementById('selection-info').textContent = 
        `√Årea: ${selection.width}√ó${selection.height}px (${tilesX}√ó${tilesY} tiles)`;
}

/* ================================
   CREAR CAMPA√ëA
================================ */
async function createCampaign() {
    if (!selectedFile) {
        alert("‚ùå Debes subir un mapa");
        return;
    }

    if (!selection) {
        alert("‚ùå Debes seleccionar una secci√≥n del mapa");
        return;
    }

    const campaignName = document.getElementById("campaign-name").value;
    const worldName = document.getElementById("world-name").value;
    const sceneName = document.getElementById("scene-name").value;

    if (!campaignName || !worldName || !sceneName) {
        alert("‚ùå Completa todos los campos obligatorios");
        return;
    }

    const formData = new FormData();
    formData.append("campaign_name", campaignName);
    formData.append("world_name", worldName);
    formData.append("world_lore", document.getElementById("world-lore").value);
    formData.append("scene_name", sceneName);
    formData.append("tile_size", parseInt(document.getElementById("tile-size").value));
    formData.append("offset_x", Math.round(selection.x));
    formData.append("offset_y", Math.round(selection.y));
    formData.append("width_px", Math.round(selection.width));
    formData.append("height_px", Math.round(selection.height));
    formData.append("map_file", selectedFile);

    try {
        const res = await fetch("/api/campaigns/create_full", {
            method: "POST",
            body: formData
        });

        const data = await res.json();

        if (res.ok) {
            window.location.href = "/campaign/" + data.id;
        } else {
            alert("‚ùå Error: " + (data.error || "Error interno"));
        }
    } catch (err) {
        alert("‚ùå Error de conexi√≥n: " + err.message);
    }
}

// Ajustar canvas al redimensionar ventana
window.addEventListener('resize', () => {
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
    draw();
});
</script>

</body>
</html>